name: Generate Index

on:
  push:
    branches: [main]
    paths:
      - 'packs/*/registry.json'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate index.json
        run: |
          python3 -c "
          import json, os, glob

          packs = []
          for rj in sorted(glob.glob('packs/*/registry.json')):
              with open(rj) as f:
                  entry = json.load(f)
              packs.append({
                  'name': entry['name'],
                  'display_name': entry['display_name'],
                  'version': entry['version'],
                  'trust_tier': entry.get('trust_tier', 'community'),
                  'categories': entry['categories'],
                  'language': entry.get('language', 'en'),
                  'sound_count': entry.get('sound_count', 0),
                  'total_size_bytes': entry.get('total_size_bytes', 0),
                  'source_repo': entry['source']['repo'],
                  **({'source_path': entry['source']['path']} if 'path' in entry['source'] else {}),
              })

          index = {
              'version': 1,
              'generated_at': '$(date -u +%Y-%m-%dT%H:%M:%SZ)',
              'packs': packs,
          }

          with open('index.json', 'w') as f:
              json.dump(index, f, indent=2)
              f.write('\n')

          print(f'Generated index.json with {len(packs)} packs')
          "

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.json
          if git diff --cached --quiet; then
            echo "No changes to index.json"
          else
            git commit -m "chore: regenerate index.json"
            git push
          fi
